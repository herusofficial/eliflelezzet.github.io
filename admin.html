<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YÃ¶netici Paneli | Elif'le Lezzet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }
        .glass-overlay { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .hidden { display: none !important; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #c2410c; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Animasyonlar */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: fadeIn 0.2s ease-out forwards; }
    </style>
</head>
<body class="text-slate-800 relative">

    <div id="notification-area" class="fixed top-5 right-5 z-[60] space-y-3 pointer-events-none"></div>

    <div id="login-view" class="min-h-screen flex items-center justify-center bg-slate-900">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4 border-t-4 border-orange-600">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-600"><i class="fa-solid fa-user-shield text-3xl"></i></div>
                <h2 class="text-3xl font-bold text-slate-800">YÃ¶netici GiriÅŸi</h2>
            </div>
            <form id="login-form" class="space-y-5">
                <input type="email" id="login-email" class="w-full p-3 border border-slate-300 rounded-lg outline-none focus:border-orange-500" placeholder="E-posta" required>
                <input type="password" id="login-password" class="w-full p-3 border border-slate-300 rounded-lg outline-none focus:border-orange-500" placeholder="Åžifre" required>
                <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
                <button type="submit" id="login-btn" class="w-full bg-orange-600 text-white py-3.5 rounded-lg font-bold hover:bg-orange-700 transition shadow-lg">GiriÅŸ Yap</button>
            </form>
        </div>
    </div>

    <div id="admin-view" class="min-h-screen flex flex-col hidden">
        <header class="bg-white border-b border-slate-200 sticky top-0 z-40">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-orange-600 text-white w-10 h-10 rounded-lg flex items-center justify-center shadow-md"><i class="fa-solid fa-layer-group"></i></div>
                    <div><h1 class="text-xl font-bold text-slate-800">YÃ¶netim Paneli</h1></div>
                </div>
                <div class="flex gap-3 items-center">
                    <button onclick="toggleCalculator()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition flex items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-calculator"></i> Maliyet Hesapla
                    </button>
                    <a href="#reviews-section" class="flex items-center gap-2 bg-white border border-slate-300 text-slate-600 px-4 py-2 rounded-lg font-medium hover:bg-slate-50 transition">
                        <i class="fa-solid fa-comments"></i> <span id="review-badge" class="bg-red-500 text-white text-[10px] px-1.5 rounded-full hidden">0</span>
                    </a>
                    <button onclick="logout()" class="bg-slate-800 text-white px-4 py-2 rounded-lg font-medium hover:bg-slate-900 transition"><i class="fa-solid fa-right-from-bracket"></i> Ã‡Ä±kÄ±ÅŸ</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-6 py-8 max-w-6xl flex-1 space-y-12">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-palette text-blue-500"></i> Tema Rengi</h2>
                        <div class="flex gap-2"><input type="text" id="accent-color" placeholder="#f97316" class="flex-1 border p-2 rounded-lg text-sm uppercase outline-none"><div id="color-preview" class="w-10 h-10 rounded-lg border shadow-sm"></div></div>
                        <button onclick="saveSettings()" class="w-full mt-3 bg-blue-50 text-blue-600 font-semibold py-2 rounded-lg text-sm hover:bg-blue-100">Kaydet</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden transition-all" id="form-container">
                        <div class="absolute top-0 left-0 w-1 h-full bg-green-500" id="form-indicator"></div>
                        <div class="flex justify-between items-center mb-6 pl-3"><h2 class="text-lg font-bold text-slate-800" id="form-title">Yeni ÃœrÃ¼n</h2><button onclick="resetForm()" id="cancel-edit-btn" class="hidden text-xs text-red-500 hover:underline">Ä°ptal</button></div>
                        <form id="product-form" class="space-y-4">
                            <input type="hidden" id="edit-id">
                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">ÃœrÃ¼n AdÄ±</label><input type="text" id="p-name" class="w-full border p-2.5 rounded-lg outline-none focus:border-green-500" required></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fiyat (TL)</label><input type="number" id="p-price" class="w-full border p-2.5 rounded-lg outline-none focus:border-green-500" required></div>
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Birim</label><select id="p-portion" class="w-full border p-2.5 rounded-lg bg-white outline-none"><option>Adet</option><option>Kg</option><option>Porsiyon</option><option>Tepsi</option><option>Dilim</option><option>Paket</option><option>Litre</option><option>Kase</option></select></div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kategori</label>
                                <select id="p-category" class="w-full border p-2.5 rounded-lg bg-white outline-none">
                                    <option value="yemek">Ana Yemekler</option>
                                    <option value="tatli">TatlÄ±lar</option>
                                    <option value="tuzlu">Tuzlular</option>
                                    <option value="kahvalti">KahvaltÄ±lÄ±k & Sos</option>
                                    <option value="meze">Mezeler & Salatalar</option>
                                    <option value="icecek">Ä°Ã§ecekler</option>
                                    <option value="diyet">Diyet / Fit</option>
                                    <option value="ozel">Ã–zel SipariÅŸ</option>
                                </select>
                            </div>
                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">GÃ¶rsel URL</label><input type="text" id="p-img" class="w-full border p-2.5 rounded-lg outline-none focus:border-green-500" required></div>
                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">AÃ§Ä±klama</label><textarea id="p-desc" rows="3" class="w-full border p-2.5 rounded-lg outline-none focus:border-green-500"></textarea></div>
                            <button type="submit" id="submit-btn" class="w-full bg-slate-900 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition shadow-md flex justify-center items-center gap-2"><i class="fa-solid fa-plus"></i> Kaydet</button>
                        </form>
                    </div>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col sm:flex-row gap-4 justify-between items-center">
                        <div class="relative w-full sm:w-1/2"><i class="fa-solid fa-search absolute left-3 top-3.5 text-slate-400"></i><input type="text" id="search-input" onkeyup="filterTable()" placeholder="ÃœrÃ¼n ara..." class="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg outline-none focus:border-orange-500"></div>
                        <div class="w-full sm:w-1/3">
                            <select id="filter-category" onchange="filterTable()" class="w-full p-2.5 border border-slate-300 rounded-lg bg-slate-50 outline-none focus:border-orange-500">
                                <option value="all">TÃ¼m Kategoriler</option>
                                <option value="yemek">Ana Yemekler</option>
                                <option value="tatli">TatlÄ±lar</option>
                                <option value="tuzlu">Tuzlular</option>
                                <option value="kahvalti">KahvaltÄ±lÄ±k & Sos</option>
                                <option value="meze">Mezeler</option>
                                <option value="icecek">Ä°Ã§ecekler</option>
                                <option value="diyet">Diyet / Fit</option>
                                <option value="ozel">Ã–zel</option>
                            </select>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead class="bg-slate-50 border-b border-slate-200"><tr class="text-xs font-bold text-slate-500 uppercase"><th class="p-4">ÃœrÃ¼n</th><th class="p-4">Kategori</th><th class="p-4">Fiyat</th><th class="p-4 text-right">Ä°ÅŸlem</th></tr></thead><tbody id="admin-product-list" class="divide-y divide-slate-100 text-sm"></tbody></table></div>
                        <div id="empty-msg" class="hidden p-8 text-center text-slate-500">ÃœrÃ¼n bulunamadÄ±.</div>
                    </div>
                </div>
            </div>

            <div id="reviews-section" class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                    <h2 class="text-2xl font-bold text-slate-800"><i class="fa-solid fa-comments text-orange-500 mr-2"></i> MÃ¼ÅŸteri YorumlarÄ±</h2>
                    <span class="text-sm text-slate-500 bg-slate-100 px-3 py-1 rounded-full" id="total-reviews-count">0 Yorum</span>
                </div>
                <div id="admin-reviews-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </main>
    </div>

    <div id="calculator-modal" class="fixed inset-0 glass-overlay z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh] modal-animate">
            
            <div class="p-6 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <h3 class="text-xl font-bold text-slate-800">
                    <i class="fa-solid fa-calculator text-green-600 mr-2"></i> Maliyet ve Kar HesaplayÄ±cÄ±
                </h3>
                <button onclick="toggleCalculator()" class="text-slate-400 hover:text-red-500 transition">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>
            
            <div class="p-8 overflow-y-auto flex-1 space-y-6">
                
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">Hesaplanacak ÃœrÃ¼n</label>
                    <select id="calc-product-select" class="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-green-200 outline-none bg-white">
                        <option value="">LÃ¼tfen listeden bir Ã¼rÃ¼n seÃ§iniz...</option>
                    </select>
                </div>

                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-bold text-slate-700">KullanÄ±lan Malzemeler</label>
                        <button onclick="addIngredientRow()" class="text-xs bg-white border border-slate-300 px-3 py-1.5 rounded hover:bg-slate-100 transition font-medium">
                            + Malzeme Ekle
                        </button>
                    </div>
                    <div id="ingredients-list" class="space-y-2">
                        </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-green-50 p-6 rounded-xl border border-green-100">
                    <div>
                        <label class="block text-xs font-bold text-green-800 uppercase mb-1">Toplam Maliyet</label>
                        <div class="text-2xl font-bold text-slate-800" id="total-cost">0.00 â‚º</div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-green-800 uppercase mb-1">Kar MarjÄ± (%)</label>
                        <input type="number" id="profit-margin" value="50" oninput="calculateTotals()" class="w-full border p-2 rounded bg-white text-lg font-bold outline-none text-center focus:ring-2 focus:ring-green-200">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-green-800 uppercase mb-1">Ã–nerilen SatÄ±ÅŸ FiyatÄ±</label>
                        <div class="text-2xl font-bold text-green-600" id="suggested-price">0.00 â‚º</div>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t bg-slate-50 rounded-b-2xl flex justify-end gap-3">
                <button onclick="toggleCalculator()" class="px-6 py-3 rounded-lg text-slate-600 font-bold hover:bg-slate-200 transition">Kapat</button>
                <button onclick="saveCalculation()" class="px-6 py-3 rounded-lg bg-green-600 text-white font-bold hover:bg-green-700 transition shadow-lg flex items-center gap-2">
                    <i class="fa-solid fa-save"></i> HesabÄ± Kaydet
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, setDoc, getDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // FIREBASE AYARLARI
        const firebaseConfig = {
            apiKey: "AIzaSyCE749Ey9zhATV5LBEbZzkgTN76oTKZ46A",
            authDomain: "elifle-lezzet.firebaseapp.com",
            projectId: "elifle-lezzet",
            storageBucket: "elifle-lezzet.firebasestorage.app",
            messagingSenderId: "470005399778",
            appId: "1:470005399778:web:1a724255739d57eb509ebb",
            measurementId: "G-5JK1Z0YHX3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const productsRef = collection(db, "products");
        const reviewsRef = collection(db, "reviews");
        const settingsDocRef = doc(db, "settings", "siteConfig");

        window.allProductsData = [];
        let firstLoad = true;

        // --- AUTH (GÄ°RÄ°Åž/Ã‡IKIÅž) ---
        onAuthStateChanged(auth, (user) => {
            const loginView = document.getElementById('login-view');
            const adminView = document.getElementById('admin-view');
            
            if (user) {
                loginView.classList.add('hidden');
                adminView.classList.remove('hidden');
                fetchProducts();
                loadSettings();
                listenForReviews();
            } else {
                loginView.classList.remove('hidden');
                adminView.classList.add('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            const err = document.getElementById('login-error');

            btn.innerHTML = '<div class="loader"></div>';
            err.classList.add('hidden');

            signInWithEmailAndPassword(auth, email, pass)
                .then(() => {})
                .catch((error) => {
                    btn.innerHTML = 'GiriÅŸ Yap';
                    err.innerText = "HatalÄ± e-posta veya ÅŸifre.";
                    err.classList.remove('hidden');
                });
        });

        window.logout = () => {
            signOut(auth).then(() => alert("Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±."));
        };

        // --- ÃœRÃœN Ä°ÅžLEMLERÄ° (CRUD) ---
        async function fetchProducts() {
            const listBody = document.getElementById('admin-product-list');
            const emptyMsg = document.getElementById('empty-msg');
            listBody.innerHTML = '';
            try {
                const q = await getDocs(productsRef);
                window.allProductsData = [];
                q.forEach(doc => window.allProductsData.push({ id: doc.id, ...doc.data() }));
                renderTable(window.allProductsData);
            } catch (e) { console.error(e); }
        }

        window.renderTable = (data) => {
            const list = document.getElementById('admin-product-list');
            const empty = document.getElementById('empty-msg');
            list.innerHTML = '';
            
            if(data.length === 0) { empty.classList.remove('hidden'); return; } 
            else { empty.classList.add('hidden'); }
            
            data.forEach(i => {
                list.innerHTML += `
                    <tr class="hover:bg-slate-50 border-b group transition">
                        <td class="p-4 flex gap-3 items-center">
                            <img src="${i.img}" class="w-10 h-10 rounded-lg border border-slate-200 object-cover">
                            <span class="font-semibold text-slate-700">${i.name}</span>
                        </td>
                        <td class="p-4"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold uppercase">${i.category}</span></td>
                        <td class="p-4 font-bold text-orange-600">${i.price} â‚º <span class="text-xs text-slate-400 font-normal">/ ${i.portion}</span></td>
                        <td class="p-4 text-right">
                            <button onclick="startEdit('${i.id}')" class="text-blue-500 hover:bg-blue-50 p-2 rounded transition"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteProduct('${i.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded transition"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        };

        window.filterTable = () => {
            const txt = document.getElementById('search-input').value.toLowerCase();
            const cat = document.getElementById('filter-category').value;
            const res = window.allProductsData.filter(i => i.name.toLowerCase().includes(txt) && (cat === 'all' || i.category === cat));
            renderTable(res);
        };

        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById("submit-btn");
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>'; btn.disabled=true;
            
            const id = document.getElementById('edit-id').value;
            const d = {
                name: document.getElementById('p-name').value,
                price: Number(document.getElementById('p-price').value),
                category: document.getElementById('p-category').value,
                portion: document.getElementById('p-portion').value,
                img: document.getElementById('p-img').value,
                desc: document.getElementById('p-desc').value,
                updatedAt: new Date()
            };
            if(!id) d.createdAt = new Date();

            try {
                if(id) await updateDoc(doc(db,"products",id), d);
                else await addDoc(productsRef, d);
                resetForm();
                fetchProducts();
                showNotification("BaÅŸarÄ±lÄ±", id ? "ÃœrÃ¼n gÃ¼ncellendi." : "ÃœrÃ¼n eklendi.");
            } catch(e){ alert(e.message); } 
            finally { btn.innerHTML=original; btn.disabled=false; }
        });

        window.deleteProduct = async (id) => { 
            if(confirm("Silmek istediÄŸinize emin misiniz?")) { 
                await deleteDoc(doc(db,"products",id)); 
                fetchProducts(); 
            }
        };
        
        window.startEdit = (id) => {
            const p = window.allProductsData.find(x=>x.id===id);
            document.getElementById('edit-id').value=id;
            document.getElementById('p-name').value=p.name;
            document.getElementById('p-price').value=p.price;
            document.getElementById('p-category').value=p.category;
            document.getElementById('p-portion').value=p.portion;
            document.getElementById('p-img').value=p.img;
            document.getElementById('p-desc').value=p.desc;
            
            document.getElementById('form-title').innerText="DÃ¼zenleniyor: " + p.name;
            document.getElementById('form-indicator').classList.replace('bg-green-500', 'bg-blue-500');
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            const btn = document.getElementById('submit-btn');
            btn.innerHTML = '<i class="fa-solid fa-rotate"></i> GÃ¼ncelle';
            btn.classList.replace('bg-slate-900', 'bg-blue-600');
            window.scrollTo({top:0,behavior:'smooth'});
        };

        window.resetForm = () => {
            document.getElementById('product-form').reset();
            document.getElementById('edit-id').value="";
            document.getElementById('form-title').innerText="Yeni ÃœrÃ¼n";
            document.getElementById('form-indicator').classList.replace('bg-blue-500', 'bg-green-500');
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            const btn = document.getElementById('submit-btn');
            btn.innerHTML = '<i class="fa-solid fa-plus"></i> Kaydet';
            btn.classList.replace('bg-blue-600', 'bg-slate-900');
        };

        // --- YORUM SÄ°STEMÄ° ---
        function listenForReviews() {
            const q = query(reviewsRef, orderBy("date", "desc"));
            onSnapshot(q, (snapshot) => {
                const listDiv = document.getElementById('admin-reviews-list');
                document.getElementById('total-reviews-count').innerText = `${snapshot.size} Yorum`;
                const badge = document.getElementById('review-badge');
                if(snapshot.size > 0) { badge.innerText = snapshot.size; badge.classList.remove('hidden'); }

                listDiv.innerHTML = '';
                if (snapshot.empty) { listDiv.innerHTML = '<div class="col-span-full text-center text-slate-400 p-10">HenÃ¼z yorum yok.</div>'; return; }

                if (!firstLoad) {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") showNotification("ðŸ”” Yeni Yorum!", change.doc.data().comment);
                    });
                }

                snapshot.forEach((docSnap) => {
                    const d = docSnap.data();
                    let stars = ''; for(let i=0; i<5; i++) stars += `<i class="fa-solid fa-star text-xs ${i < d.rating ? 'text-yellow-400' : 'text-gray-200'}"></i>`;
                    const existingReply = d.reply ? d.reply : "";
                    const replyClass = d.reply ? "bg-blue-50 border-blue-200" : "bg-slate-50 border-slate-200";

                    listDiv.innerHTML += `
                        <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm hover:shadow-md transition flex flex-col h-full">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-600 font-bold text-xs">${d.name.charAt(0)}</div>
                                    <div><h4 class="font-bold text-sm text-slate-800">${d.name} ${d.surname}</h4><div class="flex">${stars}</div></div>
                                </div>
                                <button onclick="window.deleteReview('${docSnap.id}')" class="text-slate-400 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                            </div>
                            <p class="text-sm text-slate-600 mb-4 italic flex-1">"${d.comment}"</p>
                            <div class="mt-auto">
                                <div class="p-2 rounded-lg ${replyClass} mb-2">
                                    <p class="text-[10px] font-bold text-slate-500 mb-1 uppercase"><i class="fa-solid fa-reply"></i> Elif HanÄ±m:</p>
                                    <textarea id="reply-text-${docSnap.id}" class="w-full text-xs bg-white border border-slate-300 rounded p-2 focus:outline-none focus:border-blue-500 resize-none" rows="2" placeholder="YanÄ±t yazÄ±n...">${existingReply}</textarea>
                                </div>
                                <button onclick="window.saveReply('${docSnap.id}')" class="w-full bg-slate-800 text-white text-xs py-2 rounded hover:bg-blue-600 transition">${d.reply ? 'YanÄ±tÄ± GÃ¼ncelle' : 'YanÄ±tla'}</button>
                            </div>
                        </div>`;
                });
                firstLoad = false;
            });
        }

        window.saveReply = async (reviewId) => {
            const replyText = document.getElementById(`reply-text-${reviewId}`).value;
            if(!replyText.trim()) return alert("YanÄ±t yazÄ±n.");
            try { await updateDoc(doc(db, "reviews", reviewId), { reply: replyText }); showNotification("BaÅŸarÄ±lÄ±", "YanÄ±t kaydedildi."); } catch (e) { alert("Hata"); }
        };
        window.deleteReview = async (id) => { if(confirm("Silinsin mi?")) { await deleteDoc(doc(db, "reviews", id)); showNotification("Bilgi", "Silindi."); } };
        
        function showNotification(title, msg) { 
            const area = document.getElementById('notification-area'); 
            const toast = document.createElement('div'); 
            toast.className = "notification-toast pointer-events-auto bg-white border-l-4 border-green-500 p-4 rounded shadow-xl flex items-start gap-3 w-80"; 
            toast.innerHTML = `<div><h4 class="font-bold text-sm">${title}</h4><p class="text-xs text-slate-600">${msg}</p></div>`; 
            area.appendChild(toast); 
            setTimeout(() => { toast.remove(); }, 5000); 
        }

        // --- MALÄ°YET HESAPLAYICI ---
        window.toggleCalculator = () => { 
            const modal = document.getElementById('calculator-modal'); 
            modal.classList.toggle('hidden');
            if(!modal.classList.contains('hidden')) {
                const select = document.getElementById('calc-product-select');
                select.innerHTML = '<option value="">LÃ¼tfen listeden bir Ã¼rÃ¼n seÃ§iniz...</option>';
                window.allProductsData.forEach(p => { 
                    select.innerHTML += `<option value="${p.name}">${p.name} (${p.price} â‚º)</option>`; 
                });
                const list = document.getElementById('ingredients-list'); 
                if(list.children.length === 0) addIngredientRow();
            }
        };

        window.addIngredientRow = () => { 
            const list = document.getElementById('ingredients-list'); 
            const rowId = Date.now();
            list.insertAdjacentHTML('beforeend', `
                <div class="grid grid-cols-12 gap-2 mb-2 animate-[fadeIn_0.2s_ease-in]" id="row-${rowId}">
                    <div class="col-span-5"><input class="w-full border p-2 rounded text-sm ing-name outline-none focus:border-green-500" placeholder="Malzeme"></div>
                    <div class="col-span-3"><input class="w-full border p-2 rounded text-sm ing-qty outline-none focus:border-green-500" placeholder="Miktar"></div>
                    <div class="col-span-3"><input type="number" class="w-full border p-2 rounded text-sm ing-price outline-none focus:border-green-500" oninput="calculateTotals()" placeholder="Fiyat"></div>
                    <div class="col-span-1 text-center"><button onclick="this.parentElement.parentElement.remove();calculateTotals()" class="text-red-400 hover:text-red-600 transition"><i class="fa-solid fa-trash"></i></button></div>
                </div>
            `); 
        };

        window.calculateTotals = () => { 
            let totalCost = 0; 
            document.querySelectorAll('.ing-price').forEach(i => totalCost += Number(i.value) || 0); 
            let margin = Number(document.getElementById('profit-margin').value); 
            document.getElementById('total-cost').innerText = totalCost.toFixed(2) + " â‚º"; 
            document.getElementById('suggested-price').innerText = (totalCost * (1 + margin/100)).toFixed(2) + " â‚º"; 
        };

        window.saveCalculation = async () => { 
            const productName = document.getElementById('calc-product-select').value; 
            if(!productName) return alert("ÃœrÃ¼n seÃ§in"); 
            
            const rows = document.querySelectorAll('#ingredients-list > div'); 
            let ingredients = [];
            rows.forEach(row => { 
                const name = row.querySelector('.ing-name').value; 
                const qty = row.querySelector('.ing-qty').value; 
                const price = row.querySelector('.ing-price').value; 
                if(name && price) ingredients.push({ name, qty, price: Number(price) }); 
            });
            
            if(ingredients.length === 0) return alert("Malzeme girin");
            
            try{ 
                await addDoc(collection(db, "cost_logs"), {
                    productName, 
                    ingredients, 
                    totalCost: document.getElementById('total-cost').innerText, 
                    margin: document.getElementById('profit-margin').value, 
                    suggestedPrice: document.getElementById('suggested-price').innerText, 
                    date: new Date()
                }); 
                showNotification("BaÅŸarÄ±lÄ±", "Maliyet hesabÄ± kaydedildi."); 
                toggleCalculator(); 
            } catch(e) { alert("Hata"); } 
        };

        async function loadSettings() { const d = await getDoc(settingsDocRef); if (d.exists()) { document.getElementById('accent-color').value = d.data().accentColor || '#f97316'; document.getElementById('color-preview').style.backgroundColor = d.data().accentColor || '#f97316'; } }
        window.saveSettings = async () => { const c = document.getElementById('accent-color').value; try { await setDoc(settingsDocRef, { accentColor: c }); showNotification("Ayarlar", "Renk kaydedildi."); document.getElementById('color-preview').style.backgroundColor = c; } catch(e){} };
    </script>
</body>
</html>
